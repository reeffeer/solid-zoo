1. SELECT *
   FROM accounts
   WHERE status = 'active'
     AND currency = 'EUR'
     AND opened_at > '2024-01-01'
   ORDER BY opened_at;

2. SELECT
       c.full_name,
       a.account_type,
       a.currency,
       a.status
   FROM accounts a
   JOIN clients c ON a.client_id = c.client_id;

3. SELECT
       c.client_id,
       c.full_name,
       COUNT(a.account_id) AS account_count
   FROM clients c
   LEFT JOIN accounts a ON c.client_id = a.client_id
   GROUP BY c.client_id, c.full_name
   ORDER BY c.client_id;

4. SELECT
       c.client_id,
       c.full_name,
       COUNT(a.account_id) AS active_account_count
   FROM clients c
   JOIN accounts a ON c.client_id = a.client_id
   WHERE a.status = 'active'
   GROUP BY c.client_id, c.full_name
   HAVING COUNT(a.account_id) > 2;

5. WITH incoming_totals AS (
       SELECT
           account_id,
           SUM(amount) AS total_incoming
       FROM transactions
       WHERE txn_type IN ('deposit', 'transfer_in')
       GROUP BY account_id
   ),
   bank_avg AS (
       SELECT AVG(total_incoming) AS avg_incoming
       FROM incoming_totals
   )
   SELECT
       i.account_id,
       i.total_incoming
   FROM incoming_totals i
   CROSS JOIN bank_avg b
   WHERE i.total_incoming > b.avg_incoming;

6. SELECT
       c.client_id,
       c.full_name,
       SUM(t.amount) AS total_turnover
   FROM clients c
   JOIN accounts a ON c.client_id = a.client_id
   JOIN transactions t ON a.account_id = t.account_id
   WHERE EXTRACT(YEAR FROM t.txn_date) = 2025
   GROUP BY c.client_id, c.full_name
   ORDER BY total_turnover DESC
   LIMIT 5;

7. SELECT
       c.client_id,
       c.full_name,
       COUNT(t.transaction_id) AS txn_count,
       CASE
           WHEN COUNT(t.transaction_id) = 0 THEN 'inactive'
           WHEN COUNT(t.transaction_id) BETWEEN 1 AND 5 THEN 'low'
           WHEN COUNT(t.transaction_id) BETWEEN 6 AND 20 THEN 'medium'
           WHEN COUNT(t.transaction_id) > 20 THEN 'high'
       END AS activity_level
   FROM clients c
   LEFT JOIN accounts a ON c.client_id = a.client_id
   LEFT JOIN transactions t ON a.account_id = t.account_id
       AND t.txn_date >= CURRENT_DATE - INTERVAL '90 days'
   GROUP BY c.client_id, c.full_name
   ORDER BY txn_count DESC;

8. SELECT
       l.loan_id,
       l.client_id,
       l.principal,
       COALESCE(SUM(lp.amount), 0) AS paid_amount
   FROM loans l
   LEFT JOIN loan_payments lp ON l.loan_id = lp.loan_id AND lp.status = 'success'
   GROUP BY l.loan_id, l.client_id, l.principal
   HAVING COALESCE(SUM(lp.amount), 0) < l.principal * 0.5;

9. SELECT
       c.full_name,
       crd.account_id,
       crd.issued_at,
       crd.expires_at
   FROM cards crd
   JOIN accounts a ON crd.account_id = a.account_id
   JOIN clients c ON a.client_id = c.client_id
   WHERE crd.status = 'active';

10. SELECT
        a.account_id,
        COUNT(t.transaction_id) AS total_transactions,
        COALESCE(SUM(
            CASE
                WHEN t.txn_type IN ('withdrawal', 'transfer_out', 'fee')
                THEN t.amount
                ELSE 0
            END
        ), 0) AS total_withdrawals
    FROM accounts a
    LEFT JOIN transactions t ON a.account_id = t.account_id
    GROUP BY a.account_id
    ORDER BY a.account_id;